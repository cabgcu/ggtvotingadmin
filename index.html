<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin | GGT Voting</title>
    
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://www.gstatic.com">

    <!-- Firebase SDKs -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getFirestore, collection, doc, onSnapshot, setDoc, getDocs, writeBatch, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

      // 1. Configuration: RULE 1 - Use environment-provided appId for correct permissions
      const firebaseConfig = {
        apiKey: "AIzaSyAsQeD83RdAyZPJZeAOif1gSasMhv2zp3M",
        authDomain: "gcu-s-got-talent-2026.firebaseapp.com",
        projectId: "gcu-s-got-talent-2026",
        storageBucket: "gcu-s-got-talent-2026.firebasestorage.app",
        messagingSenderId: "999052757013",
        appId: "1:999052757013:web:3f75bdbf48f921b831a61c"
      };

      // Pointing to the exact location of the GGT 2026 data
      const appId = 'c_97156435f4eefd8e_importer.html-977';
      const ADMIN_PASSWORD = "Cabgcu49!";
      
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      const contestants = [
          { id: 1, name: "Canyon Avenue" },
          { id: 2, name: "Emma Cowden" },
          { id: 3, name: "Mallary Bauman" },
          { id: 4, name: "Shae Dale" },
          { id: 5, name: "SP31" },
          { id: 6, name: "Suntwist" },
          { id: 7, name: "Sydney Miller" },
          { id: 8, name: "Tim Mullins" }
      ];

      let isVotingOpen = true;
      let currentUser = null;
      let isAuthenticated = false;

      /**
       * PASSWORD PROTECTION
       */
      window.attemptLogin = async function() {
        const passInput = document.getElementById('admin-pass');
        const errorMsg = document.getElementById('login-error');
        const loginBtn = document.querySelector('.login-btn');
        
        if (passInput.value === ADMIN_PASSWORD) {
            loginBtn.disabled = true;
            loginBtn.innerText = "Connecting...";
            
            isAuthenticated = true;
            // RULE 3: Auth BEFORE Queries
            await initAuth(); 
            
            document.getElementById('view-login').style.display = 'none';
            document.getElementById('view-admin').style.display = 'block';
        } else {
            errorMsg.innerText = "Incorrect password. Access denied.";
            passInput.value = "";
            passInput.focus();
        }
      };

      window.handlePassKey = function(e) {
        if (e.key === 'Enter') attemptLogin();
      };

      /**
       * FIREBASE AUTHENTICATION
       */
      async function initAuth() {
        try {
          updateStatusBadge("AUTHENTICATING...", "#FFA500");
          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token).catch(() => signInAnonymously(auth));
          } else {
            await signInAnonymously(auth);
          }
        } catch (error) {
          console.error("Auth failed:", error);
          updateStatusBadge("AUTH ERROR", "#ff453a");
        }
      }

      onAuthStateChanged(auth, (user) => {
        currentUser = user;
        if (user && isAuthenticated) {
          updateStatusBadge("ADMIN LIVE", "#ffffff");
          startSync();
        }
      });

      function updateStatusBadge(text, color) {
        const badge = document.getElementById('status-badge');
        if(!badge) return;
        badge.innerText = text;
        badge.style.color = color;
        badge.style.borderColor = color;
      }

      /**
       * DATA SYNCHRONIZATION
       */
      function startSync() {
        if (!currentUser || !isAuthenticated) return;

        // Sync Status (Open/Closed)
        const statusDoc = doc(db, 'artifacts', appId, 'public', 'data', 'status', 'settings');
        onSnapshot(statusDoc, (snapshot) => {
          if (snapshot.exists()) {
            isVotingOpen = snapshot.data().open !== false;
            updateStatusUI();
          } else {
            setDoc(statusDoc, { open: true }, { merge: true });
          }
        }, (err) => {
            console.error("Status Sync Error:", err);
            document.getElementById('db-status').innerText = "SYNC ERROR";
        });

        // Sync Votes
        const votesRef = collection(db, 'artifacts', appId, 'public', 'data', 'votes');
        
        onSnapshot(votesRef, (snapshot) => {
          const votes = [];
          snapshot.forEach(doc => {
            const data = doc.data();
            votes.push(data);
          });
          document.getElementById('db-status').innerText = `LIVE: ${votes.length} VOTES`;
          renderStats(votes);
          renderRecentFeed(votes);
        }, (error) => {
          console.error("Vote feed error:", error);
          document.getElementById('db-status').innerText = "FEED ERROR";
        });
      }

      /**
       * ADMIN ACTIONS
       */
      window.toggleVoting = async function() {
        if (!currentUser) return;
        const statusDoc = doc(db, 'artifacts', appId, 'public', 'data', 'status', 'settings');
        const btn = document.getElementById('toggle-btn');
        btn.disabled = true;
        try {
          await setDoc(statusDoc, { open: !isVotingOpen }, { merge: true });
        } catch (e) {
          console.error("Action blocked:", e);
        } finally {
          btn.disabled = false;
        }
      };

      window.resetVotes = async function() {
        if (!confirm("Are you sure? This deletes ALL votes currently recorded for GGT 2026.")) return;
        const btn = document.getElementById('reset-btn');
        btn.disabled = true;
        btn.innerText = "Processing Reset...";

        try {
          const votesRef = collection(db, 'artifacts', appId, 'public', 'data', 'votes');
          const snapshot = await getDocs(votesRef);
          let docsToDelete = snapshot.docs;
          
          while (docsToDelete.length > 0) {
            const batch = writeBatch(db);
            const chunk = docsToDelete.splice(0, 400);
            chunk.forEach(d => batch.delete(d.ref));
            await batch.commit();
          }
          alert("All data has been cleared.");
        } catch (e) {
          alert("Reset failed: " + e.message);
        } finally {
          btn.disabled = false;
          btn.innerText = "Reset All Data";
        }
      };

      function updateStatusUI() {
        const btn = document.getElementById('toggle-btn');
        const indicator = document.getElementById('arena-indicator');
        if (isVotingOpen) {
          btn.innerText = "Close Voting";
          btn.style.background = "#FF453A";
          indicator.innerText = "ARENA IS OPEN";
          indicator.style.color = "#30d158";
        } else {
          btn.innerText = "Open Voting";
          btn.style.background = "#30D158";
          indicator.innerText = "ARENA IS CLOSED";
          indicator.style.color = "#ff453a";
        }
      }

      function renderStats(votes) {
        const counts = {};
        votes.forEach(v => { counts[v.performerId] = (counts[v.performerId] || 0) + 1; });
        const sorted = contestants.map(c => ({ ...c, count: counts[c.id] || 0 }))
                                  .sort((a, b) => b.count - a.count || a.id - b.id);

        document.getElementById('total-votes-count').innerText = votes.length.toLocaleString();
        const grid = document.getElementById('stats-grid');
        grid.innerHTML = sorted.map((c, i) => `
          <div class="stat-card">
            <div class="rank">RANK #${i+1}</div>
            <div class="performer-name">${c.name}</div>
            <div class="vote-count">${c.count.toLocaleString()}</div>
            <div class="progress-bar-bg"><div class="progress-bar-fill" style="width: ${(c.count / (Math.max(votes.length, 1)) * 100)}%"></div></div>
          </div>
        `).join('');
      }

      function renderRecentFeed(votes) {
        const recent = [...votes]
          .filter(v => v.timestamp)
          .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0))
          .slice(0, 10);
          
        const list = document.getElementById('recent-list');
        if (recent.length === 0) { 
          list.innerHTML = '<div style="text-align:center; padding:20px; color:#555;">Waiting for incoming data...</div>'; 
          return; 
        }
        list.innerHTML = recent.map(v => `
          <div class="feed-item">
            <span><strong>${v.studentId || 'ID:' + v.voterUid?.slice(0,5)}</strong> → ${v.performerName || 'Unknown'}</span>
            <span class="timestamp">${v.timestamp ? new Date(v.timestamp.seconds * 1000).toLocaleTimeString() : 'now'}</span>
          </div>
        `).join('');
      }
    </script>

    <style>
        :root {
            --bg-dark: #000000;
            --glass: rgba(15, 15, 18, 0.94);
            --border: rgba(255, 255, 255, 0.15);
            --accent: #0A84FF;
            --text: #ffffff;
            --muted: #a1a1aa;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", system-ui, sans-serif;
            color: var(--text); background-color: var(--bg-dark); padding: 20px;
            min-height: 100vh; overflow-x: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        #bg-container { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; 
            background-color: #050505;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(10, 132, 255, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(191, 90, 242, 0.15) 0%, transparent 40%);
        }

        .container { width: 100%; max-width: 1100px; margin: 0 auto; position: relative; }

        /* --- LOGIN VIEW --- */
        #view-login { width: 100%; max-width: 380px; text-align: center; }
        .login-card {
            background: var(--glass); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
            padding: 32px; border-radius: 24px; border: 1px solid var(--border);
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }
        .login-input {
            width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--border);
            padding: 16px; border-radius: 12px; color: white; text-align: center;
            font-size: 1rem; margin: 16px 0; outline: none; transition: 0.3s;
        }
        .login-input:focus { border-color: var(--accent); box-shadow: 0 0 10px rgba(10, 132, 255, 0.2); }
        .login-btn {
            width: 100%; background: var(--accent); color: white; border: none;
            padding: 16px; border-radius: 12px; font-weight: 700; cursor: pointer;
            text-transform: uppercase; font-size: 0.9rem;
        }
        .login-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        #login-error { color: #FF453A; font-size: 0.75rem; font-weight: 600; margin-top: 12px; }

        /* --- ADMIN VIEW --- */
        #view-admin { display: none; width: 100%; }

        header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 20px; border-bottom: 1px solid var(--border); margin-bottom: 30px;
        }

        h1 { margin: 0; font-size: 1.4rem; font-weight: 900; letter-spacing: -0.02em; color: #ffffff; text-transform: uppercase; }

        .status-badge {
            padding: 5px 15px; border-radius: 100px; font-size: 0.7rem;
            font-weight: 900; border: 1px solid; background: rgba(0,0,0,0.3);
        }

        .main-controls {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px; margin-bottom: 40px;
        }

        .control-card {
            background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 30px; border-radius: 28px; border: 1px solid var(--border); text-align: center;
        }

        .big-number { font-size: 4.5rem; font-weight: 900; color: var(--accent); line-height: 1; }
        .label { font-size: 0.75rem; text-transform: uppercase; font-weight: 800; color: var(--text); margin-top: 10px; letter-spacing: 0.1em; }

        .toggle-btn {
            width: 100%; border: none; padding: 20px; border-radius: 18px;
            color: white; font-weight: 900; cursor: pointer; text-transform: uppercase;
            font-size: 1rem; margin-top: 10px; transition: transform 0.2s;
        }
        .toggle-btn:active { transform: scale(0.98); }
        .toggle-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .reset-btn {
            background: none; border: 1px solid rgba(255, 69, 58, 0.3); color: #ff453a;
            font-size: 0.7rem; padding: 12px; border-radius: 14px; margin-top: 25px; cursor: pointer;
            width: 100%; font-weight: 700; text-transform: uppercase;
        }

        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 15px; margin-bottom: 40px;
        }

        .stat-card {
            background: var(--glass); border-radius: 24px; border: 1px solid var(--border);
            padding: 24px;
        }

        .rank { font-size: 0.6rem; font-weight: 900; color: var(--accent); margin-bottom: 12px; }
        .performer-name { font-weight: 900; font-size: 1.1rem; margin-bottom: 6px; text-transform: uppercase; letter-spacing: -0.04em; }
        .vote-count { font-size: 2rem; font-weight: 900; margin-bottom: 15px; }

        .progress-bar-bg { height: 6px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #BF5AF2); transition: width 1s ease; }

        .recent-feed {
            background: var(--glass); padding: 30px; border-radius: 28px; border: 1px solid var(--border); text-align: left;
        }

        .feed-item {
            padding: 15px 0; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; font-size: 0.9rem;
        }
        .feed-item:last-child { border-bottom: none; }
        .timestamp { color: var(--muted); font-size: 0.75rem; font-family: monospace; }
        #db-status { font-size: 0.7rem; color: var(--accent); font-weight: 900; margin-top: 8px; }

        @media (max-width: 600px) { 
            h1 { font-size: 1.1rem; }
            .big-number { font-size: 3.5rem; }
        }
    </style>
</head>
<body>

<div id="bg-container"></div>

<!-- ================= LOGIN SCREEN ================= -->
<div id="view-login">
    <div class="login-card">
        <div style="color: white; margin-bottom: 16px; font-size: 0.65rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.2em;">Canyon Activities Board</div>
        <h1 style="color: white; margin-bottom: 24px; font-size: 1.8rem; letter-spacing: -0.04em;">GGT ADMIN HUB</h1>
        
        <input type="password" id="admin-pass" class="login-input" placeholder="Admin Password" onkeypress="handlePassKey(event)">
        <button class="login-btn" onclick="attemptLogin()">Log In</button>
        <div id="login-error" class="error-message"></div>
    </div>
</div>

<!-- ================= ADMIN DASHBOARD ================= -->
<div id="view-admin" class="container">
    <header>
        <h1>GGT Performance Hub</h1>
        <div id="status-badge" class="status-badge">READY...</div>
    </header>

    <div class="main-controls">
        <div class="control-card">
            <div id="total-votes-count" class="big-number">0</div>
            <div class="label">Total Recorded Votes</div>
            <div id="db-status">CONNECTING...</div>
        </div>
        
        <div class="control-card">
            <div id="arena-indicator" style="font-weight:900; margin-bottom:15px; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em;">INITIALIZING...</div>
            <button id="toggle-btn" class="toggle-btn" onclick="toggleVoting()">---</button>
            <button id="reset-btn" class="reset-btn" onclick="resetVotes()">Reset All Data</button>
        </div>
    </div>

    <h3 class="label" style="margin-bottom:15px; color: #ffffff;">Live Rankings</h3>
    <div id="stats-grid" class="stats-grid"></div>

    <div class="recent-feed">
        <h3 class="label" style="margin-bottom:15px; color: #ffffff;">Incoming Activity</h3>
        <div id="recent-list"></div>
    </div>
    
    <div style="margin-top: 40px; text-align: center; color: #ffffff; font-size: 0.6rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.2em; opacity: 0.4;">
        © 2026 Canyon Activities Board
    </div>
</div>

</body>
</html>
