<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin | GGT Voting</title>
    
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://www.gstatic.com">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getFirestore, collection, doc, onSnapshot, setDoc, getDoc, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

      // 1. Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyAsQeD83RdAyZPJZeAOif1gSasMhv2zp3M",
        authDomain: "gcu-s-got-talent-2026.firebaseapp.com",
        projectId: "gcu-s-got-talent-2026",
        storageBucket: "gcu-s-got-talent-2026.firebasestorage.app",
        messagingSenderId: "999052757013",
        appId: "1:999052757013:web:3f75bdbf48f921b831a61c"
      };

      const appId = 'c_97156435f4eefd8e_importer.html-977';
      const ADMIN_PASSWORD = "Cabgcu49!";
      
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      const contestants = [
          { id: 1, name: "Canyon Avenue" }, { id: 2, name: "Emma Cowden" },
          { id: 3, name: "Mallary Bauman" }, { id: 4, name: "Shae Dale" },
          { id: 5, name: "SP31" }, { id: 6, name: "Suntwist" },
          { id: 7, name: "Sydney Miller" }, { id: 8, name: "Tim Mullins" }
      ];

      let isVotingOpen = true;
      let syncStarted = false;
      let allArenaVotes = [];
      let onlineVotes = [];

      // --- LOGIN LOGIC ---
      window.attemptLogin = async function() {
        const passInput = document.getElementById('admin-pass');
        const loginBtn = document.querySelector('.login-btn');
        
        if (passInput.value === ADMIN_PASSWORD) {
            loginBtn.disabled = true;
            loginBtn.innerText = "VERIFYING...";
            try {
                await signInAnonymously(auth);
                document.getElementById('view-login').style.display = 'none';
                document.getElementById('view-admin').style.display = 'block';
                startSync();
            } catch (e) {
                alert("Auth Error: " + e.message);
                loginBtn.disabled = false;
            }
        } else {
            alert("Incorrect Password");
        }
      };

      window.handlePassKey = (e) => { if (e.key === 'Enter') attemptLogin(); };

      // --- REAL-TIME DATA SYNC ---
      function startSync() {
        if (syncStarted) return;
        syncStarted = true;
        
        const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'status', 'settings');
        const arenaVotesRef = collection(db, 'artifacts', appId, 'public', 'data', 'votes');
        const onlineVotesRef = collection(db, 'artifacts', appId, 'public', 'data', 'online_votes');

        onSnapshot(settingsRef, (snap) => {
          if (snap.exists()) {
            isVotingOpen = snap.data().open !== false;
            updateStatusUI();
          }
        });

        // Sync Arena (QR) + SMS Votes
        onSnapshot(arenaVotesRef, (snapshot) => {
          allArenaVotes = [];
          snapshot.forEach(doc => allArenaVotes.push(doc.data()));
          renderAllData();
        });

        // Sync Online/VIP Votes
        onSnapshot(onlineVotesRef, (snapshot) => {
          onlineVotes = [];
          snapshot.forEach(doc => onlineVotes.push(doc.data()));
          renderAllData();
        });
      }

      function renderAllData() {
        // Separate SMS from QR
        const smsVotes = allArenaVotes.filter(v => v.method === 'SMS');
        const trueArenaVotes = allArenaVotes.filter(v => v.method !== 'SMS');
        const total = allArenaVotes.length + onlineVotes.length;
        
        document.getElementById('total-votes-count').innerText = total.toLocaleString();
        document.getElementById('arena-split-count').innerText = trueArenaVotes.length.toLocaleString();
        document.getElementById('online-split-count').innerText = onlineVotes.length.toLocaleString();
        document.getElementById('sms-split-count').innerText = smsVotes.length.toLocaleString();

        document.getElementById('db-status').innerText = `LIVE: ${total} TOTAL RECORDS`;

        renderStatsGrid('stats-grid-combined', [...allArenaVotes, ...onlineVotes]);
        renderStatsGrid('stats-grid-arena', trueArenaVotes);
        renderStatsGrid('stats-grid-online', onlineVotes);
        renderStatsGrid('stats-grid-sms', smsVotes);
        
        renderRecentFeed([...allArenaVotes, ...onlineVotes]);
      }

      function renderStatsGrid(elementId, dataset) {
        const counts = {};
        dataset.forEach(v => { counts[v.performerId] = (counts[v.performerId] || 0) + 1; });
        const sorted = contestants.map(c => ({ ...c, count: counts[c.id] || 0 }))
                                  .sort((a, b) => b.count - a.count || a.id - b.id);

        const grid = document.getElementById(elementId);
        const max = Math.max(dataset.length, 1);
        
        grid.innerHTML = sorted.map((c, i) => `
          <div class="stat-card">
            <div class="rank">RANK #${i+1}</div>
            <div class="performer-name">${c.name}</div>
            <div class="vote-count">${c.count.toLocaleString()}</div>
            <div class="progress-bar-bg"><div class="progress-bar-fill" style="width: ${(c.count / max * 100)}%"></div></div>
          </div>
        `).join('');
      }

      function renderRecentFeed(votes) {
        const recent = [...votes]
          .filter(v => v.timestamp)
          .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0))
          .slice(0, 10);
          
        const list = document.getElementById('recent-list');
        list.innerHTML = recent.length ? recent.map(v => `
          <div class="feed-item">
            <span><strong>${v.studentId || v.voterName || 'VIP'}</strong> <span style="opacity:0.6; font-size:0.7em;">${v.method || 'WEB'}</span> â†’ ${v.performerName}</span>
            <span class="timestamp">${new Date(v.timestamp.seconds * 1000).toLocaleTimeString()}</span>
          </div>
        `).join('') : '<div style="padding:20px; text-align:center; opacity:0.5;">Awaiting Activity...</div>';
      }

      window.toggleVoting = async function() {
        const btn = document.getElementById('toggle-btn');
        btn.disabled = true;
        try {
          const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'status', 'settings');
          await setDoc(settingsRef, { open: !isVotingOpen }, { merge: true });
        } finally { btn.disabled = false; }
      };

      window.resetVotes = async function() {
        if (!confirm("âš ï¸ DANGER: This wipes ALL data. Are you sure?")) return;
        const btn = document.getElementById('reset-btn');
        btn.disabled = true;
        btn.innerText = "WIPING...";
        
        try {
          const arenaSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'votes'));
          const onlineSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'online_votes'));
          
          let batch = writeBatch(db);
          let count = 0;
          const allDocs = [...arenaSnap.docs, ...onlineSnap.docs];

          for(const d of allDocs) {
              batch.delete(d.ref);
              count++;
              if(count >= 400) { await batch.commit(); batch = writeBatch(db); count = 0; }
          }
          if(count > 0) await batch.commit();
          alert("Reset Complete.");
        } finally { 
          btn.disabled = false; 
          btn.innerText = "Reset All Data";
        }
      };

      // --- TURBO SMS IMPORT (Parallel Processing) ---
      window.runSMSImport = function() {
        const file = document.getElementById('sms-csv').files[0];
        if(!file) return alert("Select CSV!");

        const btn = document.getElementById('import-btn');
        const status = document.getElementById('import-status');
        
        btn.disabled = true;
        status.innerText = "ðŸš€ STARTING TURBO SYNC...";
        status.style.color = "#FF9F0A"; // Orange

        Papa.parse(file, {
            header: false,
            skipEmptyLines: true,
            complete: async (results) => {
                const rows = results.data.slice(1); // Skip header row
                const total = rows.length;
                
                // Process in chunks of 100
                const CHUNK_SIZE = 100;
                let processed = 0;
                let validAdded = 0;
                let fakeBlocked = 0;

                for (let i = 0; i < total; i += CHUNK_SIZE) {
                    const chunk = rows.slice(i, i + CHUNK_SIZE);
                    const batch = writeBatch(db);
                    let batchHasUpdates = false;

                    // 1. Create array of check promises (Parallel)
                    const promises = chunk.map(async (row) => {
                        const id = row[3]?.toString().trim(); // Col D
                        const vote = row[6]?.toString().trim(); // Col G
                        
                        if (!id || !vote) return null;

                        // Check ID validity against database
                        const validRef = doc(db, 'artifacts', appId, 'public', 'data', 'valid_ids', id);
                        
                        try {
                            const snap = await getDoc(validRef);
                            if (snap.exists()) {
                                const performer = contestants.find(c => vote.toLowerCase().includes(c.name.toLowerCase()));
                                if (performer) {
                                    // Queue valid vote
                                    const voteRef = doc(db, 'artifacts', appId, 'public', 'data', 'votes', id);
                                    batch.set(voteRef, {
                                        studentId: id,
                                        performerId: performer.id,
                                        performerName: performer.name,
                                        method: 'SMS',
                                        timestamp: serverTimestamp()
                                    }, { merge: true });
                                    return true; // Valid
                                }
                            }
                        } catch(e) { console.error(e); }
                        return false; // Invalid/Fake
                    });

                    // 2. Wait for chunk to finish
                    const results = await Promise.all(promises);
                    
                    results.forEach(r => {
                        if (r === true) { validAdded++; batchHasUpdates = true; }
                        else if (r === false) { fakeBlocked++; }
                    });

                    // 3. Commit valid votes
                    if (batchHasUpdates) await batch.commit();

                    processed += chunk.length;
                    const pct = Math.round((processed / total) * 100);
                    status.innerText = `âš¡ SPEED SYNC: ${pct}% COMPLETED...`;
                }

                status.innerText = `âœ… DONE: ${validAdded} ADDED | ${fakeBlocked} FAKES BLOCKED`;
                status.style.color = "#30D158"; // Green
                btn.disabled = false;
                file.value = "";
            }
        });
      };

      function updateStatusUI() {
        const btn = document.getElementById('toggle-btn');
        const indicator = document.getElementById('arena-indicator');
        btn.innerText = isVotingOpen ? "Close Voting" : "Open Voting";
        btn.style.background = isVotingOpen ? "#FF453A" : "#30D158";
        indicator.innerText = isVotingOpen ? "VOTING IS OPEN" : "VOTING IS CLOSED";
        indicator.style.color = isVotingOpen ? "#30d158" : "#ff453a";
      }
    </script>

    <style>
        :root { --bg: #000; --glass: rgba(15,15,18,0.96); --border: rgba(255,255,255,0.12); --accent: #0A84FF; --text: #fff; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, system-ui, sans-serif; color: var(--text); background: var(--bg); padding: 20px; min-height: 100vh; }
        #bg-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; background-image: radial-gradient(circle at 10% 20%, rgba(10,132,255,0.1) 0%, transparent 45%), radial-gradient(circle at 90% 80%, rgba(191,90,242,0.1) 0%, transparent 45%); }
        .container { width: 100%; max-width: 1200px; margin: 0 auto; }
        #view-login { height: 80vh; display: flex; align-items: center; justify-content: center; }
        .login-card { background: var(--glass); backdrop-filter: blur(30px); padding: 40px 32px; border-radius: 32px; border: 1px solid var(--border); width: 380px; text-align: center; }
        .login-input { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--border); padding: 18px; border-radius: 16px; color: #fff; text-align: center; margin: 20px 0; outline: none; font-weight: 800; font-size: 1rem; }
        .login-btn { width: 100%; background: var(--accent); color: #fff; border: none; padding: 18px; border-radius: 100px; font-weight: 900; cursor: pointer; text-transform: uppercase; }
        #view-admin { display: none; width: 100%; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .main-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 40px; }
        .control-card { background: var(--glass); padding: 30px; border-radius: 28px; border: 1px solid var(--border); text-align: center; display: flex; flex-direction: column; justify-content: center; }
        .big-number { font-size: 3.5rem; font-weight: 900; color: var(--accent); line-height: 1; letter-spacing: -0.05em; }
        .label { font-size: 0.7rem; text-transform: uppercase; font-weight: 900; letter-spacing: 0.15em; color: #fff; margin: 10px 0; }
        .toggle-btn { width: 100%; border: none; padding: 20px; border-radius: 100px; color: #fff; font-weight: 900; cursor: pointer; text-transform: uppercase; }
        .reset-btn { background: none; border: 1px solid rgba(255,69,58,0.2); color: #ff453a; font-size: 0.7rem; padding: 12px; border-radius: 14px; margin-top: 20px; cursor: pointer; width: 100%; font-weight: 900; text-transform: uppercase; }
        .section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; margin-top: 40px; }
        .section-header .line { flex: 1; height: 1px; background: var(--border); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 15px; margin-bottom: 40px; }
        .stat-card { background: var(--glass); border-radius: 24px; border: 1px solid var(--border); padding: 24px; }
        .rank { font-size: 0.6rem; font-weight: 900; color: var(--accent); margin-bottom: 8px; }
        .performer-name { font-weight: 900; font-size: 1.1rem; text-transform: uppercase; letter-spacing: -0.03em; }
        .vote-count { font-size: 2rem; font-weight: 900; margin: 5px 0; }
        .progress-bar-bg { height: 6px; background: rgba(255,255,255,0.04); border-radius: 10px; overflow: hidden; margin-top: 10px; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #BF5AF2); transition: width 1.2s ease; }
        .recent-feed { background: var(--glass); padding: 30px; border-radius: 32px; border: 1px solid var(--border); }
        .feed-item { padding: 12px 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; }
        .timestamp { color: #555; font-size: 0.75rem; }
        #db-status { font-size: 0.65rem; font-weight: 900; color: var(--accent); margin-top: 8px; }
        .sub-stat { font-size: 1.5rem; font-weight: 900; color: #fff; }
        
        /* Importer UI */
        .importer-container { margin-top: 50px; background: var(--glass); border: 1px solid var(--border); border-radius: 32px; padding: 30px; }
        .file-input { background: rgba(255,255,255,0.05); border: 1px dashed var(--border); padding: 20px; border-radius: 16px; width: 100%; color: #fff; margin-bottom: 15px; }
    </style>
</head>
<body>
<div id="bg-container"></div>

<div id="view-login">
    <div class="login-card">
        <div class="label" style="opacity:0.4">Canyon Activities Board</div>
        <h1 style="margin: 10px 0 24px 0; font-size: 2rem; font-weight: 900; letter-spacing: -0.04em; text-transform: uppercase;">GGT VOTING ADMIN</h1>
        <input type="password" id="admin-pass" class="login-input" placeholder="ACCESS PASSWORD" onkeypress="handlePassKey(event)">
        <button class="login-btn" onclick="attemptLogin()">Log In</button>
    </div>
</div>

<div id="view-admin" class="container">
    <header>
        <h1 style="font-size:1.3rem; text-transform: uppercase; font-weight: 900; letter-spacing: -0.02em;">GGT VOTING ADMIN</h1>
        <div style="font-size: 0.65rem; font-weight: 900; padding: 6px 16px; border: 1px solid #fff; border-radius: 50px; text-transform: uppercase;">LIVE DATA FEED</div>
    </header>

    <div class="main-controls">
        <div class="control-card">
            <div id="total-votes-count" class="big-number">0</div>
            <div class="label">Total Combined Votes</div>
            <div id="db-status">SCANNING...</div>
        </div>
        <div class="control-card">
            <div style="display:flex; justify-content:space-around; align-items:center; width:100%;">
                <div>
                    <div id="arena-split-count" class="sub-stat">0</div>
                    <div class="label" style="font-size: 0.55rem;">Arena (ID)</div>
                </div>
                <div style="width:1px; height:40px; background: var(--border);"></div>
                <div>
                    <div id="online-split-count" class="sub-stat">0</div>
                    <div class="label" style="font-size: 0.55rem;">VIP (Online)</div>
                </div>
                <div style="width:1px; height:40px; background: var(--border);"></div>
                <div>
                    <div id="sms-split-count" class="sub-stat" style="color: #BF5AF2;">0</div>
                    <div class="label" style="font-size: 0.55rem; color: #BF5AF2;">SMS Import</div>
                </div>
            </div>
        </div>
        <div class="control-card">
            <div id="arena-indicator" class="label" style="margin-bottom:12px;">INITIALIZING...</div>
            <button id="toggle-btn" class="toggle-btn" onclick="toggleVoting()">---</button>
            <button id="reset-btn" class="reset-btn" onclick="resetVotes()">Reset All Data</button>
        </div>
    </div>

    <div class="section-header">
        <div class="label">Official Leaderboard (Combined)</div>
        <div class="line"></div>
    </div>
    <div id="stats-grid-combined" class="stats-grid"></div>

    <div class="section-header">
        <div class="label">Arena Votes (Student ID)</div>
        <div class="line"></div>
    </div>
    <div id="stats-grid-arena" class="stats-grid"></div>

    <div class="section-header">
        <div class="label">VIP / Online Votes</div>
        <div class="line"></div>
    </div>
    <div id="stats-grid-online" class="stats-grid"></div>

    <div class="section-header">
        <div class="label" style="color: #BF5AF2;">SMS / Text Votes</div>
        <div class="line" style="background: rgba(191,90,242,0.3);"></div>
    </div>
    <div id="stats-grid-sms" class="stats-grid"></div>

    <div class="importer-container">
        <div class="section-header" style="margin-top:0;">
            <div class="label">SMS Data Management (Turbo Mode)</div>
            <div class="line"></div>
        </div>
        <p class="label" style="text-transform:none; letter-spacing:0; font-size:0.8rem; margin-bottom:20px;">
            Parallel Check Enabled: Upload CSV. System will verify 100 IDs at a time against "valid_ids".
            <br><span style="opacity:0.6;">Mapping: Column D = Student ID, Column G = Vote Choice.</span>
        </p>
        
        <input type="file" id="sms-csv" class="file-input" accept=".csv">
        <button id="import-btn" class="login-btn" onclick="runSMSImport()" style="width:auto; padding: 15px 40px;">Run Turbo Import</button>
        <div id="import-status" class="label" style="margin-top:15px; font-size:0.8rem;">READY</div>
    </div>

    <div class="recent-feed" style="margin-top: 40px;">
        <div class="label" style="margin-bottom:15px; opacity:0.4;">Combined Activity Stream</div>
        <div id="recent-list"></div>
    </div>
    
    <div class="label" style="margin-top: 50px; text-align: center; opacity: 0.5;">
        Â© 2026 Canyon Activities Board
    </div>
</div>
</body>
</html>
